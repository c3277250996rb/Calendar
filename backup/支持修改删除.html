<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>æ¯å°æ—¶ä¸€æ ¼æ—¶é—´è½´ - äº¤äº’æ·»åŠ ä»»åŠ¡</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }
        .timeline {
            position: relative;
            display: flex;
            flex-direction: column;
            padding-left: 80px;
        }
        .time-block {
            position: relative;
            height: 37px;
            border-left: 2px solid #ddd;
            border-bottom: 1px dashed #eee;
        }
        .time-label {
            position: absolute;
            left: -80px;
            top: 1px;
            height: 24px;
            line-height: 24px;
            font-size: 14px;
            color: #666;
            padding: 0 6px;
            width: 70px;
            text-align: right;
            user-select: none;
            margin-top: calc(-12px);
        }
        .task {
            background: #4caf50;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
            margin-left: 30px;
            margin-top: 0px;
            user-select: none;
            cursor: pointer;
        }
        .scale-line {
            position: absolute;
            left: 0;
            height: 2px;
            background: #888;
        }
        .scale-small {
            width: 8px;
        }
        .scale-large {
            width: 20px;
            background: #444;
        }
        #now-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: red;
            z-index: 99;
        }
    </style>
</head>
<body>

    <div class="timeline" id="timeline"></div>

    <script>
        const timeline = document.getElementById("timeline");
        const startHour = 0;
        const endHour = 23;
        let blockHeight;

        // 1. è·å–å—é«˜åº¦
        const tempBlock = document.createElement("div");
        tempBlock.className = "time-block";
        tempBlock.style.visibility = "hidden";
        document.body.appendChild(tempBlock);
        blockHeight = tempBlock.getBoundingClientRect().height;
        document.body.removeChild(tempBlock);

        // 2. æ¯å—30åˆ†é’Ÿ
        const minutesPerBlock = 30;

        // 3. ä»»åŠ¡æ˜ å°„ï¼ˆæ”¯æŒæ›´ç²¾ç»†æ—¶é—´ï¼‰
        const taskMap = {};
        function loadTasks() {
            const saved = localStorage.getItem("timelineTasks");
            if (saved) {
                Object.assign(taskMap, JSON.parse(saved));
            }
        }
        function saveTasks() {
            localStorage.setItem("timelineTasks", JSON.stringify(taskMap));
        }
        loadTasks();

        // 4. ç”Ÿæˆæ—¶é—´å—ï¼ˆæ¯å°æ—¶ä¸¤å—ï¼‰
        for (let h = startHour; h <= endHour; h++) {
            for (let m = 0; m < 60; m += 30) {
                const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                const block = document.createElement("div");
                block.className = "time-block";
                block.id = `time-${h}-${m}`;
                block.dataset.time = timeStr;

                if (m === 0) {
                    block.innerHTML = `<div class="time-label">${timeStr}</div>`;
                }

                if (taskMap[timeStr]) {
                    block.innerHTML += `<div class="task">${taskMap[timeStr]}</div>`;
                }

                // ç‚¹å‡»æ·»åŠ /ä¿®æ”¹ä»»åŠ¡
                block.addEventListener("click", function (e) {
                    if (e.target.classList.contains("task")) {
                        const oldText = e.target.innerText;
                        const newText = prompt("ä¿®æ”¹ä»»åŠ¡å†…å®¹ï¼ˆç•™ç©ºåˆ™åˆ é™¤ï¼‰ï¼š", oldText);

                        if (newText === null) {
                            // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä»€ä¹ˆéƒ½ä¸åš
                            return;
                        }

                        if (newText.trim() === "") {
                            // åˆ é™¤ä»»åŠ¡
                            e.target.remove();
                            delete taskMap[timeStr];
                            saveTasks();
                        } else {
                            // ä¿®æ”¹ä»»åŠ¡
                            e.target.innerText = newText;
                            taskMap[timeStr] = newText;
                            saveTasks();
                        }

                        e.stopPropagation();
                        return;
                    }


                    if (!this.querySelector(".task")) {
                        const taskName = prompt(`ä¸º ${timeStr} æ·»åŠ ä»»åŠ¡ï¼š`);
                        if (taskName && taskName.trim() !== "") {
                            const taskDiv = document.createElement("div");
                            taskDiv.className = "task";
                            taskDiv.innerText = taskName;
                            this.appendChild(taskDiv);
                            taskMap[timeStr] = taskName;
                            saveTasks();
                        }
                    }
                });

                // åˆ»åº¦çº¿ï¼ˆæ¯10åˆ†é’Ÿï¼‰
                for (let mm = 0; mm <= 30; mm += 10) {
                    const scaleLine = document.createElement("div");
                    scaleLine.classList.add("scale-line");
                    scaleLine.classList.add(mm % 30 === 0 ? "scale-large" : "scale-small");
                    const topPx = (mm / minutesPerBlock) * blockHeight;
                    scaleLine.style.top = `${topPx}px`;
                    block.appendChild(scaleLine);
                }

                timeline.appendChild(block);
            }
        }

        // 5. å½“å‰æ—¶é—´çº¢çº¿
        const nowLine = document.createElement("div");
        nowLine.id = "now-line";
        timeline.appendChild(nowLine);

        function updateNowLineAndScroll() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const startMinutes = startHour * 60;
            const offsetMinutes = currentMinutes - startMinutes;

            if (offsetMinutes < 0 || offsetMinutes > (endHour - startHour + 1) * 60) return;

            const topPos = offsetMinutes * (blockHeight / minutesPerBlock);
            nowLine.style.top = `${topPos}px`;

            const nearestH = now.getHours();
            const nearestM = now.getMinutes() < 30 ? 0 : 30;
            const targetId = `time-${nearestH}-${nearestM}`;
            const target = document.getElementById(targetId);
            if (target) {
                target.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        updateNowLineAndScroll();
        setInterval(updateNowLineAndScroll, 60000);


        // æ¸…é™¤æ•°æ®æ§åˆ¶å°å‘½ä»¤ğŸ‘‰ localStorage.removeItem("timelineTasks");

    </script>
</body>
</html>
